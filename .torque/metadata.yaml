spec_version: 2.0

description: AyvCodr - AI API Platform with Granular Management and Privacy Toolkit. Supports both ECS Fargate and EKS Kubernetes deployments with comprehensive security and monitoring.

metadata:
  template_name: ayvcodr-aws-deployment-with-kubernetes
  template_version: 2.0.0
  
inputs:
  - domain_name:
      type: string
      default: "ayvcodr.com"
      description: "Primary domain name for the application"
  
  - environment:
      type: string
      default: "production"
      allowed_values: ["development", "staging", "production"]
      description: "Deployment environment"
  
  - instance_type:
      type: string
      default: "t3.medium"
      allowed_values: ["t3.small", "t3.medium", "t3.large", "c5.large"]
      description: "EC2 instance type for backend services"
  
  - enable_ssl:
      type: boolean
      default: true
      description: "Enable SSL certificate via AWS Certificate Manager"
  
  - database_instance_class:
      type: string
      default: "db.t3.micro"
      allowed_values: ["db.t3.micro", "db.t3.small", "db.t3.medium"]
      description: "RDS instance class for PostgreSQL database"
  
  - deployment_type:
      type: string
      default: "ecs"
      allowed_values: ["ecs", "eks", "both"]
      description: "Deployment type: ECS Fargate, EKS Kubernetes, or both"
  
  - kubernetes_version:
      type: string
      default: "1.28"
      allowed_values: ["1.27", "1.28", "1.29"]
      description: "Kubernetes version for EKS cluster"

outputs:
  - frontend_url:
      value: "https://{{ .inputs.domain_name }}"
      description: "Frontend application URL"
  
  - api_url:
      value: "https://{{ .inputs.domain_name }}/api"
      description: "Backend API URL"
  
  - database_endpoint:
      value: "{{ .grains.database.outputs.endpoint }}"
      description: "RDS database endpoint"
  
  - eks_cluster_name:
      value: "{{ .grains.eks.outputs.cluster_name }}"
      description: "EKS cluster name"
      condition: "{{ eq .inputs.deployment_type 'eks' }} || {{ eq .inputs.deployment_type 'both' }}"
  
  - eks_cluster_endpoint:
      value: "{{ .grains.eks.outputs.cluster_endpoint }}"
      description: "EKS cluster endpoint"
      condition: "{{ eq .inputs.deployment_type 'eks' }} || {{ eq .inputs.deployment_type 'both' }}"
  
  - kubeconfig_command:
      value: "aws eks update-kubeconfig --region us-east-1 --name {{ .grains.eks.outputs.cluster_name }}"
      description: "Command to update kubectl configuration"
      condition: "{{ eq .inputs.deployment_type 'eks' }} || {{ eq .inputs.deployment_type 'both' }}"

grains:
  # Security Foundation
  - security:
      kind: terraform
      spec: infrastructure/security.tf
      inputs:
        - environment: "{{ .inputs.environment }}"
        - domain_name: "{{ .inputs.domain_name }}"
        - vpc_id: "{{ .grains.networking.outputs.vpc_id }}"
      depends_on:
        - networking

  # VPC and Networking
  - networking:
      kind: terraform
      spec: infrastructure/networking.tf
      inputs:
        - environment: "{{ .inputs.environment }}"
        - domain_name: "{{ .inputs.domain_name }}"
  
  # Database
  - database:
      kind: terraform
      spec: infrastructure/database.tf
      inputs:
        - environment: "{{ .inputs.environment }}"
        - instance_class: "{{ .inputs.database_instance_class }}"
        - vpc_id: "{{ .grains.networking.outputs.vpc_id }}"
        - private_subnet_ids: "{{ .grains.networking.outputs.private_subnet_ids }}"
      depends_on:
        - networking
  
  # Backend Services
  - backend:
      kind: terraform
      spec: infrastructure/backend.tf
      inputs:
        - environment: "{{ .inputs.environment }}"
        - instance_type: "{{ .inputs.instance_type }}"
        - vpc_id: "{{ .grains.networking.outputs.vpc_id }}"
        - private_subnet_ids: "{{ .grains.networking.outputs.private_subnet_ids }}"
        - database_url: "{{ .grains.database.outputs.connection_string }}"
        - domain_name: "{{ .inputs.domain_name }}"
      depends_on:
        - networking
        - database
        - security
  
  # Frontend
  - frontend:
      kind: terraform
      spec: infrastructure/frontend.tf
      inputs:
        - environment: "{{ .inputs.environment }}"
        - domain_name: "{{ .inputs.domain_name }}"
        - api_endpoint: "{{ .grains.backend.outputs.api_endpoint }}"
        - enable_ssl: "{{ .inputs.enable_ssl }}"
      depends_on:
        - backend
  
  # Load Balancer and SSL
  - load_balancer:
      kind: terraform
      spec: infrastructure/load_balancer.tf
      inputs:
        - environment: "{{ .inputs.environment }}"
        - domain_name: "{{ .inputs.domain_name }}"
        - vpc_id: "{{ .grains.networking.outputs.vpc_id }}"
        - public_subnet_ids: "{{ .grains.networking.outputs.public_subnet_ids }}"
        - backend_target_group: "{{ .grains.backend.outputs.target_group_arn }}"
        - frontend_s3_bucket: "{{ .grains.frontend.outputs.s3_bucket_domain }}"
        - enable_ssl: "{{ .inputs.enable_ssl }}"
      depends_on:
        - networking
        - backend
        - frontend

  # EKS Kubernetes Cluster (conditional)
  - eks:
      kind: terraform
      spec: infrastructure/eks.tf
      inputs:
        - environment: "{{ .inputs.environment }}"
        - vpc_id: "{{ .grains.networking.outputs.vpc_id }}"
        - private_subnet_ids: "{{ .grains.networking.outputs.private_subnet_ids }}"
        - public_subnet_ids: "{{ .grains.networking.outputs.public_subnet_ids }}"
        - domain_name: "{{ .inputs.domain_name }}"
      depends_on:
        - networking
        - security
      condition: "{{ eq .inputs.deployment_type 'eks' }} || {{ eq .inputs.deployment_type 'both' }}"

  # Monitoring and Logging
  - monitoring:
      kind: terraform
      spec: infrastructure/monitoring.tf
      inputs:
        - environment: "{{ .inputs.environment }}"
        - vpc_id: "{{ .grains.networking.outputs.vpc_id }}"
        - ecs_cluster_name: "{{ .grains.backend.outputs.cluster_name }}"
        - ecs_service_name: "{{ .grains.backend.outputs.service_name }}"
        - alb_arn: "{{ .grains.load_balancer.outputs.alb_dns_name }}"
        - db_instance_identifier: "ayvcodr-{{ .inputs.environment }}-db"
        - eks_cluster_name: "{{ .grains.eks.outputs.cluster_name }}"
      depends_on:
        - networking
        - backend
        - load_balancer
        - database